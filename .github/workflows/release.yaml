name: Release

on:
  push:
    tags: [ "v*.*.*" ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Tag or branch to build (e.g., v1.0.0 or main)'
        required: false
        type: string
        default: 'main'
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

env:
  JAVA_VERSION: '17'
  FLUTTER_VERSION: '3.38.7'
  ANDROID_API_LEVEL: '36'  # Android 16 beta
  ANDROID_NDK_VERSION: '27.3.13750724'  # NDK r27d
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  PKL_VERSION: '0.29.1'

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      # 1. Setup tools first (can be cached independently)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: platforms;android-${{ env.ANDROID_API_LEVEL }} ndk;${{ env.ANDROID_NDK_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust tools (just, rust-script)
        uses: taiki-e/install-action@v2
        with:
          tool: just,rust-script

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      # 2. Checkout code (needed by just install-tools)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}
          submodules: recursive
          fetch-depth: 0

      # Cache small tools so install-tools can skip already-installed ones
      - name: Cache installed tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.local/bin
            ~/.uv
          key: ${{ runner.os }}-tools-${{ env.FLUTTER_VERSION }}-${{ env.PKL_VERSION }}-${{ env.PNPM_VERSION }}
          restore-keys: |
            ${{ runner.os }}-tools-

      # 3. Install small tools via justfile (pkl, uv, patch-package)
      - name: Install project tools
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/bin:$PATH"
          just install-tools

      # 3. Install project dependencies
      - name: Get dependencies
        run: flutter pub get

      - name: Install frontend dependencies
        run: cd frontend && pnpm install

      - name: Accept Android licenses
        run: yes | flutter doctor --android-licenses || true

      - name: Setup signing
        if: env.KEYSTORE_BASE64 != ''
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > platforms/android/keystore.jks
          printf 'storePassword=%s\nkeyPassword=%s\n' \
            "$KEYSTORE_PASSWORD" "$KEY_PASSWORD" \
            > platforms/android/key.properties
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Run CI Pipeline
        run: just ci
        env:
          # Skip problematic postinstall scripts
          DISABLE_OPENCOLLECTIVE: true
          ADBLOCK: true

      - name: Generate SHA256 checksums
        run: |
          cd build/app/outputs/apk/release
          for apk in webfly-v*.apk; do
            sha256sum "$apk" > "${apk}.sha256"
          done

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webfly-release-apk
          path: |
            build/app/outputs/apk/release/*.apk
            build/app/outputs/apk/release/*.sha256
          if-no-files-found: warn

      - name: Generate changelog with AI
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.create_release == 'true')
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        run: |
          TAG="${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref_name }}"
          just gen-changelog --tag "$TAG" --output /tmp/changelog.md

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.create_release == 'true')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref_name }}
          files: |
            build/app/outputs/apk/release/webfly-v*.apk
            build/app/outputs/apk/release/webfly-v*.sha256
            build/app/outputs/bundle/release/webfly-v*.aab
          body_path: /tmp/changelog.md
          fail_on_unmatched_files: false
