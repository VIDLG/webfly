name: Build Android

on:
  push:
    tags: [ "v*.*.*" ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Tag or branch to build (e.g., v1.0.0 or main)'
        required: false
        type: string
        default: 'main'
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

env:
  JAVA_VERSION: '17'
  FLUTTER_VERSION: '3.38.9'
  ANDROID_API_LEVEL: '36'  # Android 16 beta
  ANDROID_NDK_VERSION: '27.3.13750724'  # NDK r27d
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  PKL_VERSION: '0.26.3'

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      # 1. Setup tools first (can be cached independently)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust tools (just, rust-script)
        uses: taiki-e/install-action@v2
        with:
          tool: just,rust-script

      - name: Install pkl
        run: |
          mkdir -p ~/.local/bin
          curl -L -o ~/.local/bin/pkl https://github.com/apple/pkl/releases/download/${{ env.PKL_VERSION }}/pkl-linux-amd64
          chmod +x ~/.local/bin/pkl
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install patch-package globally
        run: npm install -g patch-package

      # Cache all installed tools
      - name: Cache installed tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.local/bin
            ~/.uv
          key: ${{ runner.os }}-tools-${{ env.FLUTTER_VERSION }}-${{ env.PKL_VERSION }}-${{ env.PNPM_VERSION }}
          restore-keys: |
            ${{ runner.os }}-tools-

      # 2. Checkout code after tools are ready
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}
          submodules: recursive
          fetch-depth: 0

      # 3. Install project dependencies
      - name: Get dependencies
        run: flutter pub get

      - name: Accept Android licenses
        run: yes | flutter doctor --android-licenses || true

      - name: Run CI Pipeline
        run: just ci
        env:
          # Skip problematic postinstall scripts
          DISABLE_OPENCOLLECTIVE: true
          ADBLOCK: true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webfly-release-apk
          path: build/app/outputs/apk/release/*.apk
          if-no-files-found: warn

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.create_release == 'true')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref_name }}
          files: build/app/outputs/apk/release/*.apk
          generate_release_notes: true
