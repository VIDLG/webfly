// App native generation config
// Run: rust-script flutter/tools/flutter-gen-platforms.rs --config flutter/app.pkl

import "pkl:yaml"

typealias ProjectName = String(matches(Regex(#"^[A-Za-z][A-Za-z0-9_]*$"#)))
typealias Org = String(matches(Regex(#"^[A-Za-z][A-Za-z0-9_]*(\.[A-Za-z][A-Za-z0-9_]*)*$"#)))

local pubspecYaml = read("pubspec.yaml")
local pubspecData = new yaml.Parser { useMapping = true }.parse(pubspecYaml)
local version = pubspecData["version"] as String

project_name: ProjectName = pubspecData["name"] as String
org: Org = "org.vidlg"
description: String(length > 0) = "webfly is like webf go / expo go, focused on rendering target web pages"

pubspec {
  name = pubspecData["name"] as String
  description = pubspecData["description"] as String
  version = version
  homepage = pubspecData["homepage"] as String
}

platforms_dir = "platforms"

create {
  platforms = List("android", "windows")
  android_language = "kotlin"
}

android {
  gradle_wrapper {
    distribution_url = "https://mirrors.huaweicloud.com/gradle/gradle-8.14-all.zip"
  }

  app {
    build {
      application_id = "\(org).\(project_name)"
      namespace = "\(org).\(project_name)"
      output_file_name = "\(project_name)-v\(version)-${name}.apk"
      abi_filters = List("armeabi-v7a", "arm64-v8a")
      // 禁用 Kotlin 增量编译以避免跨盘符路径问题
      kotlin_incremental = false
    }
  }

  build {
    allprojects {
      repositories = List(
        "https://maven.aliyun.com/repository/public",
        "https://maven.aliyun.com/repository/google",
        "https://maven.aliyun.com/repository/jcenter"
      )
    }
  }

  settings {
    plugin_management {
      repositories = List(
        "https://maven.aliyun.com/repository/public",
        "https://maven.aliyun.com/repository/google",
        "https://maven.aliyun.com/repository/gradle-plugin",
        "https://maven.aliyun.com/repository/jcenter"
      )
    }
  }
}

windows {
  // Windows platform configuration (minimal - using defaults from flutter create)
  enabled = true
  window_width = 720
  window_height = 1280
}

ios = null
